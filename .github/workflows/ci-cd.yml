name: CI/CD Pipeline

on:
  push:
    branches:
      - master
      - pre-release/**
      - release/**

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  IMAGE_FRONTEND: ${{ secrets.DOCKER_USERNAME }}/frontend
  IMAGE_BACKEND: ${{ secrets.DOCKER_USERNAME }}/backend

jobs:
  build-test:
    name: Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # --- Backend ---
      - name: Setup Node.js for backend
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: npm run build || echo "No build step defined"

      - name: Backend validations
        working-directory: backend
        run: |
          npm run lint || echo "No lint configured"
          # npm test   <-- enable if tests exist

      # --- Frontend ---
      - name: Setup Node.js for frontend
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Frontend validations
        working-directory: frontend
        run: |
          npm run lint || echo "No lint configured"
          # npm test   <-- enable if tests exist

  docker-build-push:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: build-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set image tags
        id: vars
        run: |
          SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
          BRANCH_NAME=$(echo $GITHUB_REF_NAME | tr '/' '-')
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          echo "IMAGE_TAG=$BRANCH_NAME-$SHORT_SHA" >> $GITHUB_ENV

      - name: Build backend image
        run: docker build -f Dockerfile.backend -t $IMAGE_BACKEND:${IMAGE_TAG} backend

      - name: Build frontend image
        run: docker build -f Dockerfile.frontend -t $IMAGE_FRONTEND:${IMAGE_TAG} frontend

      - name: Push backend image
        run: docker push $IMAGE_BACKEND:${IMAGE_TAG}

      - name: Push frontend image
        run: docker push $IMAGE_FRONTEND:${IMAGE_TAG}

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: docker-build-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.27.0

      - name: Configure Kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_DEV }}" > kubeconfig
          export KUBECONFIG=$(pwd)/kubeconfig

      - name: Determine target namespace
        id: namespace
        run: |
          BRANCH=${GITHUB_REF_NAME}
          if [[ "$BRANCH" == "master" ]]; then
            echo "NAMESPACE=dev" >> $GITHUB_ENV
          elif [[ "$BRANCH" == pre-release/* ]]; then
            echo "NAMESPACE=preprod" >> $GITHUB_ENV
          elif [[ "$BRANCH" == release/* ]]; then
            echo "NAMESPACE=release" >> $GITHUB_ENV
          else
            echo "NAMESPACE=dev" >> $GITHUB_ENV
          fi
          echo "Deploying branch $BRANCH to namespace $NAMESPACE"

      - name: Set images for deployment
        run: |
          IMAGE_TAG=${BRANCH_NAME}-${SHORT_SHA}
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: Deploy backend
        run: |
          kubectl -n $NAMESPACE set image deployment/backend backend=$IMAGE_BACKEND:$IMAGE_TAG
          kubectl -n $NAMESPACE rollout status deployment/backend

      - name: Deploy frontend
        run: |
          kubectl -n $NAMESPACE set image deployment/frontend frontend=$IMAGE_FRONTEND:$IMAGE_TAG
          kubectl -n $NAMESPACE rollout status deployment/frontend
